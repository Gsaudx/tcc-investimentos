# Database

This document describes the database schema, relationships, and data model.

## Overview

- **Database:** PostgreSQL 16
- **ORM:** Prisma 7.x with Driver Adapters
- **Schema Location:** `backend/prisma/schema.prisma`
- **Multi-tenant Model:** User (Advisor role) -> Clients -> Wallets -> Positions/Transactions

## Enums

```prisma
enum UserRole {
  ADVISOR         // Investment advisor (full access to their clients)
  CLIENT          // Client (access only to own portfolio)
  ADMIN           // System administrator
}

enum RiskProfile {
  CONSERVATIVE    // Conservative profile
  MODERATE        // Moderate profile
  AGGRESSIVE      // Aggressive profile
}

enum AssetType {
  STOCK           // Stock (PETR4, VALE3)
  OPTION          // Option (PETRA1, VALEB2)
}

enum OptionType {
  CALL            // Call option
  PUT             // Put option
}

enum ExerciseType {
  AMERICAN        // Can exercise at any time
  EUROPEAN        // Can only exercise at expiration
}

enum TransactionType {
  BUY             // Asset purchase
  SELL            // Asset sale
  DIVIDEND        // Dividend receipt
  SPLIT           // Stock split
  SUBSCRIPTION    // Bonus/Subscription
  DEPOSIT         // Cash deposit to wallet
  WITHDRAWAL      // Cash withdrawal from wallet
}

enum OptimizationAlgorithm {
  KNAPSACK        // Integer Knapsack Algorithm
}

enum OptimizationStatus {
  GENERATED       // Suggestion generated by algorithm
  ACCEPTED        // Accepted by advisor (executed)
  REJECTED        // Rejected by advisor
}

enum InviteStatus {
  PENDING         // Client created, no invite generated
  SENT            // Token generated and available for use
  ACCEPTED        // Client accepted, account linked
  REJECTED        // Invite was revoked by advisor
}
```

## Table Structure

### Core Business

```prisma
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  name          String
  cpfCnpj       String?
  phone         String?
  role          UserRole @default(ADVISOR)  // ADVISOR, CLIENT, ADMIN
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  clients       Client[] @relation("AdvisorClients")  // Advisor's clients
  clientProfile Client?  @relation("LinkedUser")      // Linked profile (if CLIENT)

  @@map("users")  // Database table: "users"
}

model Client {
  id              String       @id @default(uuid())
  advisorId       String       // FK to User (responsible advisor)
  userId          String?      @unique  // FK to User (linked account)
  name            String
  email           String?
  cpf             String
  phone           String?
  riskProfile     RiskProfile  @default(MODERATE)
  inviteToken     String?      @unique  // Invite token (INV-XXXXXXXX)
  inviteStatus    InviteStatus @default(PENDING)  // Invite status
  inviteExpiresAt DateTime?    // Token expiration
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  wallets         Wallet[]
}

model Wallet {
  id          String  @id @default(uuid())
  clientId    String
  name        String
  description String?
  cashBalance Decimal @default(0) @db.Decimal(18, 2)  // Available cash balance
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
```

### Assets and Derivatives

```prisma
model Asset {
  id        String    @id @default(uuid())
  ticker    String    @unique   // E.g.: PETR4, VALE3, PETRA1
  name      String               // E.g.: "Petrobras PN"
  type      AssetType            // STOCK or OPTION
  sector    String?              // E.g.: "Energy", "Mining"
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model OptionDetail {
  id                String       @id @default(uuid())
  assetId           String       @unique
  underlyingAssetId String       // FK to underlying asset (e.g.: PETR4 is underlying of PETRA1)
  optionType        OptionType   // CALL or PUT
  exerciseType      ExerciseType // AMERICAN or EUROPEAN
  strikePrice       Decimal      @db.Decimal(18, 2)  // Strike price
  expirationDate    DateTime     @db.Date            // Expiration date
}
```

### Positions and Transactions

```prisma
model Position {
  id           String  @id @default(uuid())
  walletId     String
  assetId      String
  quantity     Decimal @db.Decimal(18, 8)  // Asset quantity
  averagePrice Decimal @db.Decimal(18, 2)  // ACQUISITION average price (not market price)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([walletId, assetId])  // One position per asset per wallet
}

model Transaction {
  id         String          @id @default(uuid())
  walletId   String
  assetId    String?         // Null for DEPOSIT/WITHDRAWAL
  type       TransactionType
  quantity   Decimal?        @db.Decimal(18, 8)
  price      Decimal?        @db.Decimal(18, 2)
  totalValue Decimal         @db.Decimal(18, 2)
  executedAt DateTime
  notes      String?
  createdAt  DateTime        @default(now())
}
```

### Optimization (Scientific Research)

```prisma
model OptimizationRun {
  id              String                @id @default(uuid())
  walletId        String
  algorithm       OptimizationAlgorithm
  inputParameters Json                  // Algorithm input parameters
  outputResult    Json                  // Generated result/suggestion
  status          OptimizationStatus    @default(GENERATED)
  acceptedAt      DateTime?
  createdAt       DateTime              @default(now())
}

model RebalanceLog {
  id                String   @id @default(uuid())
  walletId          String
  optimizationRunId String
  snapshotBefore    Json     // Wallet state BEFORE rebalancing
  snapshotAfter     Json     // Wallet state AFTER rebalancing
  executedAt        DateTime @default(now())
}
```

## Table Descriptions

### Core Business

| Table      | Purpose                                                                                                                                                                                                             |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **User**   | System user with JWT authentication. The `role` field defines the type: ADVISOR, CLIENT, or ADMIN. Advisors are the **main tenant** of the multi-tenant model - each advisor only sees their own clients.          |
| **Client** | Advisor's client. Contains CPF, risk profile and contact data. An advisor can have N clients.                                                                                                                       |
| **Wallet** | Investment portfolio. Each client can have multiple wallets (e.g., "Retirement", "Short Term"). The `cashBalance` field represents available cash for investing.                                                    |

### Assets and Derivatives

| Table            | Purpose                                                                                                                                                                     |
| ---------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Asset**        | Tradeable financial asset. Can be **stock** or **option**. The `type` field differentiates.                                                                                 |
| **OptionDetail** | Option details (1:1 relation with Asset). Stores: underlying asset, type (CALL/PUT), exercise style, strike and expiration. Essential for calculating **Moneyness** (ITM/OTM). |

### Positions and Transactions

| Table           | Purpose                                                                                                                  |
| --------------- | ------------------------------------------------------------------------------------------------------------------------ |
| **Position**    | Current position of an asset in a wallet. Stores quantity and **acquisition average price**. Unique per `[walletId, assetId]` pair. |
| **Transaction** | Transaction history (append-only). Includes: buys, sells, dividends, splits, deposits and withdrawals.                   |

> **Important: Average Price vs Market Price**
>
> The `Position.averagePrice` field is the **purchase average price** (what the client paid), not the current market price.
>
> | Concept            | Source                   | Use                          |
> | ------------------ | ------------------------ | ---------------------------- |
> | **Average Price**  | Calculated from transactions | Tax, realized profit/loss   |
> | **Market Price**   | External API (B3, Yahoo) | Current portfolio value      |
>
> **Example:** Client bought 100 PETR4 at R$30 and 50 more at R$36.
>
> - Average price (database): R$32.00 (acquisition cost)
> - Market price (API): R$38.00 (current quote)
> - Unrealized profit: R$6.00/share (+18.75%)

### Optimization (Scientific Research)

| Table               | Purpose                                                                                                                   |
| ------------------- | ------------------------------------------------------------------------------------------------------------------------- |
| **OptimizationRun** | Integer Knapsack algorithm execution. Stores input parameters, suggested result and status (generated/accepted/rejected). |
| **RebalanceLog**    | Record of executed rebalances. Keeps before/after wallet snapshot for audit and historical analysis.                      |

## Relationship Diagram

```
User 1:N Client 1:N Wallet
Wallet 1:N Position
Wallet 1:N Transaction
Wallet 1:N OptimizationRun 1:N RebalanceLog
Asset 1:N Position
Asset 1:N Transaction
Asset 1:1 OptionDetail
```

## Database Commands

```bash
# Generate Prisma Client (required before running)
npx prisma generate

# Apply migrations in development
npx prisma migrate dev

# Apply migrations in production
npx prisma migrate deploy

# Open Prisma Studio (database browser)
npx prisma studio

# Reset database (development only)
npx prisma migrate reset
```
